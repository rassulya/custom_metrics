
services:
  gpu-exporter:
    build:
      context: ./gpu_process_exporter
      dockerfile: Dockerfile
    container_name: gpu-process-exporter
    restart: unless-stopped
    ports:
      - "{{ gpu_exporter_port }}:9200"
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - RUST_LOG=info
    init: true
    cap_add:
      - SYS_PTRACE
      - DAC_READ_SEARCH
      - SYS_ADMIN
    volumes:
      - /proc:/mnt/proc:ro
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - /etc/nsswitch.conf:/etc/nsswitch.conf:ro
    privileged: true
    networks:
      - {{ monitoring_network }}

  disk-exporter:
    build:
      context: ./disk_usage_exporter
      dockerfile: Dockerfile
    container_name: disk-usage-exporter
    restart: unless-stopped
    ports:
      - "{{ disk_exporter_port }}:9201"
    environment:
      - RUST_LOG=info
    init: true
    security_opt:
      - seccomp:unconfined
      - apparmor=unconfined
    cap_add:
      - DAC_READ_SEARCH
    volumes:
      - /home:/mnt/home:ro
      - /raid:/mnt/raid:ro
      - /data:/mnt/data:ro
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
    networks:
      - {{ monitoring_network }}

  temp-tracker:
    build:
      context: ./tmp_file_exporter
      dockerfile: Dockerfile
    container_name: temp-file-tracker
    restart: unless-stopped
    ports:
      - "{{ temp_exporter_port }}:9202"
    environment:
      - RUST_LOG=info
    init: true
    cap_add:
      - DAC_READ_SEARCH
    volumes:
      - /tmp:/tmp:ro
      - /var/tmp:/var/tmp:ro
      - /scratch:/scratch:ro
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
    networks:
      - {{ monitoring_network }}

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    ports:
      - "{{ node_exporter_port }}:9100"
    init: true
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      - '--web.listen-address=:9100'
      - '--collector.textfile.directory=/host/textfiles'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
      - /var/lib/node_exporter/textfiles:/host/textfiles:ro
    networks:
      - {{ monitoring_network }}

  dcgm-exporter:
    image: nvcr.io/nvidia/k8s/dcgm-exporter:3.1.8-3.1.5-ubuntu20.04
    container_name: dcgm-exporter
    restart: unless-stopped
    runtime: nvidia
    ports:
      - "{{ dcgm_exporter_port }}:9400"
    init: true
    environment:
      - DCGM_EXPORTER_LISTEN=:9400
      - DCGM_EXPORTER_KUBERNETES=false
      - NVIDIA_VISIBLE_DEVICES=all
    networks:
      - {{ monitoring_network }}

networks:
  {{ monitoring_network }}:
    driver: bridge