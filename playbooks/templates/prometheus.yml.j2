# templates/prometheus.yml.j2
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Master node monitoring
{% if inventory_hostname in groups['monitoring_master'] %}
  - job_name: 'master-node-exporter'
    static_configs:
      - targets: ['node-exporter-master:9100']
    scrape_interval: 5s
{% endif %}

  # GPU nodes monitoring
{% for host in groups['gpu_nodes'] %}
  - job_name: 'gpu-exporter-{{ hostvars[host]['inventory_hostname'] }}'
    static_configs:
      - targets: ['{{ hostvars[host]['ansible_host'] }}:{{ gpu_exporter_port }}']
    scrape_interval: 10s
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: '{{ hostvars[host]['inventory_hostname'] }}'
      - source_labels: [__address__]
        target_label: node_type
        replacement: 'gpu_node'

  - job_name: 'dcgm-exporter-{{ hostvars[host]['inventory_hostname'] }}'
    static_configs:
      - targets: ['{{ hostvars[host]['ansible_host'] }}:{{ dcgm_exporter_port }}']
    scrape_interval: 10s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: '{{ hostvars[host]['inventory_hostname'] }}'

  - job_name: 'disk-exporter-{{ hostvars[host]['inventory_hostname'] }}'
    static_configs:
      - targets: ['{{ hostvars[host]['ansible_host'] }}:{{ disk_exporter_port }}']
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: '{{ hostvars[host]['inventory_hostname'] }}'

  - job_name: 'temp-tracker-{{ hostvars[host]['inventory_hostname'] }}'
    static_configs:
      - targets: ['{{ hostvars[host]['ansible_host'] }}:{{ temp_exporter_port }}']
    scrape_interval: 60s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: '{{ hostvars[host]['inventory_hostname'] }}'

  - job_name: 'node-exporter-{{ hostvars[host]['inventory_hostname'] }}'
    static_configs:
      - targets: ['{{ hostvars[host]['ansible_host'] }}:{{ node_exporter_port }}']
    scrape_interval: 15s
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: '{{ hostvars[host]['inventory_hostname'] }}'
{% endfor %}